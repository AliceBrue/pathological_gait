# This script is used to deploy SCONE optimization folders for 2d experiments on the Biorob computer cluster.
# combinations_dir_root contains five folders and each one of these folders contains experiment folders generated by scone_recursive_parser scripts.
# If one of these child folders are empty or are not available, make sure to comment the srun lines accordingly. Otherwise, cluster job will stop immediately if a folder is empty.
# results_dir is where results will be stored.
#Â Make sure to update SCONE_DIR accordingly.
# To deploy this file on a production node, run: sbatch -p prod cluster_run_2d.sbatch
# To deploy this file on a development node, run: sbatch cluster_run_2d.sbatch (make sure to update the number of cores and memory pool.)

#!/bin/bash

#SBATCH -J scone_benghorb
#SBATCH -o slurm.out
#SBATCH -e slurm.err
#SBATCH -N 1 # number of nodes
#SBATCH -n 40 # number of cores
#SBATCH --mem 20G # memory pool for all cores
#SBATCH --mail-user=salim.benghorbel@epfl.ch
#SBATCH --mail-type=fail
# #SBATCH --time=00:01:00

echo "running on hosts: $SLURM_NODELIST"
echo "running on $SLURM_NNODES nodes."
echo "running $SLURM_NTASKS tasks."
echo "current working directory is `pwd`"

# setup scone path (Please change SCONE_DIR accordingly!)
export SCONE_DIR=/shared-dev/benghorb/scone
export PATH=$SCONE_DIR/bin:$PATH
export LD_LIBRARY_PATH=$SCONE_DIR/lib:$LD_LIBRARY_PATH

results_dir=/shared-dev/benghorb/results/2d/
combinations_dir_root=/shared-dev/benghorb/cluster_runs/exports/geyer_solLV_multiobjective_stance_KL_swing_KL_2
combinations_dir0=$combinations_dir_root/first_run/
combinations_dir1=$combinations_dir_root/second_run/
combinations_dir2=$combinations_dir_root/third_run/
combinations_dir3=$combinations_dir_root/fourth_run/
combinations_dir4=$combinations_dir_root/fifth_run/
# run sconecmd
srun -n 1 find $combinations_dir0 -type f -name "*scone_main.scone" | while read file_name; do sconecmd -o "$file_name" -q -s -r $results_dir;  done &
srun -n 1 find $combinations_dir1 -type f -name "*scone_main.scone" | while read file_name; do sconecmd -o "$file_name" -q -s -r $results_dir;  done &
srun -n 1 find $combinations_dir2 -type f -name "*scone_main.scone" | while read file_name; do sconecmd -o "$file_name" -q -s -r $results_dir;  done &
srun -n 1 find $combinations_dir3 -type f -name "*scone_main.scone" | while read file_name; do sconecmd -o "$file_name" -q -s -r $results_dir;  done &
srun -n 1 find $combinations_dir4 -type f -name "*scone_main.scone" | while read file_name; do sconecmd -o "$file_name" -q -s -r $results_dir;  done
echo "program finished"
